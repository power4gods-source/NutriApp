// Copia este archivo a social_auth_google_apple.dart (sustituyendo el stub)
// después de añadir al pubspec.yaml:
//   google_sign_in: ^6.2.2
//   sign_in_with_apple: ^6.1.3
// y ejecutar en la carpeta nutri_track: flutter pub get

import 'dart:convert';
import 'package:http/http.dart' as http;
import 'package:google_sign_in/google_sign_in.dart';
import 'package:sign_in_with_apple/sign_in_with_apple.dart';
import 'auth_service.dart';

class SocialAuthGoogleApple {
  static Future<Map<String, dynamic>> loginWithGoogle(AuthService auth) async {
    try {
      final googleSignIn = GoogleSignIn(scopes: ['email', 'profile']);
      final account = await googleSignIn.signIn();
      if (account == null) {
        return {'success': false, 'error': 'Inicio de sesión cancelado'};
      }
      final authData = await account.authentication;
      final idToken = authData.idToken;
      if (idToken == null || idToken.isEmpty) {
        return {'success': false, 'error': 'No se pudo obtener el token de Google'};
      }
      final url = await auth.baseUrl;
      final response = await http.post(
        Uri.parse('$url/auth/google'),
        headers: {'Content-Type': 'application/json'},
        body: jsonEncode({'id_token': idToken}),
      ).timeout(const Duration(seconds: 15));
      if (response.statusCode == 200) {
        final data = jsonDecode(response.body) as Map<String, dynamic>;
        await auth.saveAuthDataFromMap(data);
        return {'success': true, 'data': data};
      }
      final err = jsonDecode(response.body) as Map<String, dynamic>;
      return {'success': false, 'error': err['detail'] ?? 'Error al iniciar sesión con Google'};
    } catch (e) {
      return {'success': false, 'error': e.toString()};
    }
  }

  static Future<Map<String, dynamic>> loginWithApple(AuthService auth) async {
    try {
      final credential = await SignInWithApple.getAppleIDCredential(
        scopes: [
          AppleIDAuthorizationScopes.email,
          AppleIDAuthorizationScopes.fullName,
        ],
      );
      final identityToken = credential.identityToken;
      if (identityToken == null || identityToken.isEmpty) {
        return {'success': false, 'error': 'No se pudo obtener el token de Apple'};
      }
      final url = await auth.baseUrl;
      final body = <String, dynamic>{
        'identity_token': identityToken,
        'user_apple_id': credential.userIdentifier,
        'email': credential.email,
        'full_name': credential.givenName != null || credential.familyName != null
            ? '${credential.givenName ?? ''} ${credential.familyName ?? ''}'.trim()
            : null,
      };
      final response = await http.post(
        Uri.parse('$url/auth/apple'),
        headers: {'Content-Type': 'application/json'},
        body: jsonEncode(body),
      ).timeout(const Duration(seconds: 15));
      if (response.statusCode == 200) {
        final data = jsonDecode(response.body) as Map<String, dynamic>;
        await auth.saveAuthDataFromMap(data);
        return {'success': true, 'data': data};
      }
      final err = jsonDecode(response.body) as Map<String, dynamic>;
      return {'success': false, 'error': err['detail'] ?? 'Error al iniciar sesión con Apple'};
    } catch (e) {
      return {'success': false, 'error': e.toString()};
    }
  }
}
